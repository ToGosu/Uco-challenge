# ModSecurity Configuration
# Modo de detección (no bloquea, solo registra)
SecRuleEngine DetectionOnly

# Directorio de datos de ModSecurity
SecDataDir /var/log/modsec/

# Configuración de logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec/modsec_audit.log

# Tamaño máximo del cuerpo de la petición
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Timeout para procesamiento del cuerpo
SecRequestBodyTimeoutAction Reject

# Reglas básicas de seguridad
# Prevenir SQL Injection
SecRule ARGS "@detectSQLi" \
    "id:1001,\
    phase:2,\
    block,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'OWASP_CRS',\
    tag:'attack-sqli',\
    severity:'CRITICAL'"

# Prevenir XSS
SecRule ARGS "@detectXSS" \
    "id:1002,\
    phase:2,\
    block,\
    msg:'XSS Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'OWASP_CRS',\
    tag:'attack-xss',\
    severity:'CRITICAL'"

# Prevenir inyección de comandos
SecRule ARGS "@detectCmdInjection" \
    "id:1003,\
    phase:2,\
    block,\
    msg:'Command Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'OWASP_CRS',\
    tag:'attack-injection',\
    severity:'CRITICAL'"

# Rate limiting básico (opcional, comentado por defecto)
# SecAction "id:1004,\
#     phase:1,\
#     nolog,\
#     pass,\
#     initcol:ip=%{REMOTE_ADDR},\
#     initcol:user=%{REMOTE_ADDR},\
#     setvar:ip.requests=+1,\
#     deprecatevar:ip.requests=10/60"

# Excluir endpoints de health check y actuator
SecRule REQUEST_URI "@beginsWith /health" \
    "id:1005,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /actuator" \
    "id:1006,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

